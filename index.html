<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>或者 OR | 會員中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --brand-color: #3a4a3a; --bg-color: #f9f7f2; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); color: var(--brand-color); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 40px 30px; border-radius: 2px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 400px; border-top: 5px solid var(--brand-color); text-align: center; }
        .brand-logo { width: 120px; height: auto; margin: 0 auto 15px auto; display: block; }
        .slogan { font-size: 16px; letter-spacing: 3px; color: var(--brand-color); margin-bottom: 10px; font-weight: 300; opacity: 0.9; }
        .status-text { font-size: 13px; color: #888; margin-bottom: 25px; letter-spacing: 1px; }
        .points-box { background: #f0f0f0; padding: 25px; margin-bottom: 25px; }
        .points-num { font-size: 48px; font-weight: bold; }
        .btn { background: var(--brand-color); color: white; border: none; padding: 15px; width: 100%; font-size: 15px; letter-spacing: 2px; cursor: pointer; transition: 0.3s; margin-top: 10px; display: block; text-decoration: none; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-outline { background: white !important; color: var(--brand-color) !important; border: 1px solid var(--brand-color) !important; }
        .footer-logo { margin-top: 40px; font-style: italic; opacity: 0.5; font-size: 11px; }
        #redeem-section { border-top: 1px dashed #ddd; margin-top: 25px; padding-top: 25px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <img src="https://raw.githubusercontent.com/tom0322/my-line-liff/main/logo.png" alt="或者 OR Logo" class="brand-logo">
    <div class="slogan">讓夥伴發光</div>
    <div id="status" class="status-text">讀取中...</div>

    <div id="action-area" style="display:none;">
        <div class="points-box">
            <div id="points-display" class="points-num">--</div>
            <div style="font-size: 12px; margin-top: 5px;">目前累積勳章</div>
        </div>
        
        <div id="msg-box" style="margin-bottom: 20px; font-weight: bold; font-size: 14px; min-height: 20px;"></div>

        <button id="showRedeemBtn" class="btn">前往兌換獎勵</button>
        <button id="closeBtn" class="btn btn-outline">關閉視窗</button>

        <div id="redeem-section">
            <p style="font-size: 13px; margin-bottom: 15px;">請向店員出示此畫面<br>確認後點擊下方扣除 10 枚勳章</p>
            <button id="finalRedeemBtn" class="btn" style="background-color: #8b0000;">確認扣點兌換</button>
            <button id="backBtn" class="btn btn-outline" style="display:none; margin-top:10px;">回到集點頁面</button>
        </div>
    </div>

    <div class="footer-logo">讓在地人驕傲 旅行者憧憬 - 或者。</div>
</div>

<script>
    const LIFF_ID = "2008901106-Au1lEG1Q"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXuwYOyVmNes71__tI9JvhjTYVGfvWEbbm0Fg_zbc2W00ZVPPi9rFyEDGoGfn27374/exec";
    let userProfile = null;
    let userPoints = 0;

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            
            const urlParams = new URLSearchParams(window.location.search);
            const act = urlParams.get('act');
            
            const response = await fetch(SCRIPT_URL + "?uid=" + userProfile.userId);
            userPoints = parseInt(await response.text()) || 0;
            
            document.getElementById('status').innerText = `你好，${userProfile.displayName}`;
            document.getElementById('action-area').style.display = 'block';
            
            if (act === 'v') {
                document.getElementById('msg-box').innerText = "您的勳章紀錄如上";
            } else if (act === 'm') {
                showRedeem();
            } else {
                userPoints += 1;
                document.getElementById('msg-box').innerText = "今日勳章已自動存入紀錄";
                sendData('add', userProfile, true); 
            }
            
            refreshUI();
            
            document.getElementById('showRedeemBtn').onclick = showRedeem;
            document.getElementById('closeBtn').onclick = () => liff.closeWindow();
            document.getElementById('backBtn').onclick = () => {
                document.getElementById('redeem-section').style.display = 'none';
                document.getElementById('showRedeemBtn').style.display = 'block';
                document.getElementById('msg-box').innerText = "您的勳章紀錄如上";
            };

            document.getElementById('finalRedeemBtn').onclick = () => {
                if (userPoints >= 10) {
                    const btn = document.getElementById('finalRedeemBtn');
                    btn.disabled = true;
                    btn.innerText = "兌換處理中...";
                    document.getElementById('msg-box').innerText = "正在通訊中，請稍候...";
                    sendData('minus', userProfile);
                }
            };

        } catch (err) {
            document.getElementById('status').innerText = "連線異常，請重新掃描";
        }
    }

    function refreshUI() {
        document.getElementById('points-display').innerText = userPoints;
        const redeemBtn = document.getElementById('finalRedeemBtn');
        if (userPoints < 10) {
            redeemBtn.disabled = true;
            redeemBtn.innerText = "勳章不足";
        } else {
            redeemBtn.disabled = false;
            redeemBtn.innerText = "確認扣點兌換";
        }
    }

    function showRedeem() {
        document.getElementById('redeem-section').style.display = 'block';
        document.getElementById('showRedeemBtn').style.display = 'none';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function sendData(actionType, profile, silent = false) {
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                userId: profile.userId,
                displayName: profile.displayName,
                action: actionType
            })
        }).then(() => {
            if (!silent) {
                userPoints -= 10;
                refreshUI();
                alert("兌換成功！已扣除 10 枚勳章。");
                // 兌換成功後，隱藏兌換按鈕，顯示回到集點按鈕
                document.getElementById('finalRedeemBtn').style.display = 'none';
                document.getElementById('backBtn').style.display = 'block';
                document.getElementById('msg-box').innerText = "獎勵已兌換完成！";
            }
        });
    }
    main();
</script>
</body>
</html>
